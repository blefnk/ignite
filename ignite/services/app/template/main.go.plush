package main

import (
	"context"
	"fmt"

	hplugin "github.com/hashicorp/go-plugin"

	"github.com/ignite/cli/v28/ignite/services/app"
	"<%= ModuleName %>/cmd"
)

type app struct{}

func (app) Manifest(_ context.Context) (*app.Manifest, error) {
	return &app.Manifest{
		Name: "<%= Name %>",<%= if (SharedHost) { %>
		SharedHost: true,<% } %>
		Commands: cmd.GetCommands(),
	}, nil
}

func (app) Execute(ctx context.Context, c *app.ExecutedCommand, _ app.ClientAPI) error {
	// Remove the first two elements "ignite" and "<%= Name %>" from OsArgs.
	args := c.OsArgs[2:]
	
	switch args[0] {
	case "hello":
		return cmd.ExecuteHello(ctx, c)
	default:
		return fmt.Errorf("unknown command: %s", c.Path)
	}
}

func (app) ExecuteHookPre(_ context.Context, _ *app.ExecutedHook, _ app.ClientAPI) error {
	return nil
}

func (app) ExecuteHookPost(_ context.Context, _ *app.ExecutedHook, _ app.ClientAPI) error {
	return nil
}

func (app) ExecuteHookCleanUp(_ context.Context, _ *app.ExecutedHook, _ app.ClientAPI) error {
	return nil
}

func main() {
	hplugin.Serve(&hplugin.ServeConfig{
		HandshakeConfig: app.HandshakeConfig(),
		Plugins: map[string]hplugin.Plugin{
			"<%= Name %>": app.NewGRPC(&app{}),
		},
		GRPCServer: hplugin.DefaultGRPCServer,
	})
}
